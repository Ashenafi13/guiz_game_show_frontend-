<div class="container-fluid">
  <div class="row">
    <div class="col-sm-12">
      <div class="card">
        <div class="card-header">
          <h5>Questions Management</h5>
          <div class="card-header-right">
            <div class="d-flex justify-content-end gap-2">
              <select class="form-select form-select-sm" style="width: auto;" [(ngModel)]="selectedEpisodeId" (change)="onEpisodeFilterChange()">
                <option value="">All Episodes</option>
                <option *ngFor="let episode of episodes" [value]="episode._id">{{ episode.title }}</option>
              </select>
              <button class="btn btn-primary btn-sm" (click)="openAddModal()">
                <i class="feather icon-plus me-1"></i>Add Question
              </button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- Error Alert -->
          <div *ngIf="error" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="feather icon-alert-circle me-2"></i>{{ error }}
            <button type="button" class="btn-close" (click)="error = ''" aria-label="Close"></button>
          </div>

          <!-- Loading Spinner -->
          <div *ngIf="loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>

          <!-- Questions Table -->
          <div *ngIf="!loading" class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Question</th>
                  <th>Episode</th>
                  <th>Type</th>
                  <th>Difficulty</th>
                  <th>Points</th>
                  <th>Time Limit</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let question of questions; let i = index">
                  <td>{{ i + 1 }}</td>
                  <td>
                    <div class="text-truncate" style="max-width: 300px;" [title]="question.questionText">
                      {{ question.questionText }}
                    </div>
                  </td>
                  <td>{{ getEpisodeName(question.episodeId) }}</td>
                  <td>
                    <span class="badge bg-info">{{ question.questionType }}</span>
                  </td>
                  <td>
                    <span class="badge"
                      [ngClass]="{
                        'bg-success': question.difficulty === 'easy',
                        'bg-warning': question.difficulty === 'medium',
                        'bg-danger': question.difficulty === 'hard'
                      }">
                      {{ question.difficulty }}
                    </span>
                  </td>
                  <td>{{ question.points }}</td>
                  <td>{{ question.timeLimit }}s</td>
                  <td>
                    <span class="badge" [ngClass]="question.isActive ? 'bg-success' : 'bg-secondary'">
                      {{ question.isActive ? 'Active' : 'Inactive' }}
                    </span>
                  </td>
                  <td>
                    <div class="d-flex gap-2">
                      <button class="btn btn-sm btn-outline-primary" (click)="openEditModal(question)" title="Edit">
                        <i class="feather icon-edit"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-danger" (click)="openDeleteModal(question)" title="Delete">
                        <i class="feather icon-trash-2"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="questions.length === 0">
                  <td colspan="9" class="text-center py-4">
                    <i class="feather icon-inbox" style="font-size: 48px; color: #ccc;"></i>
                    <p class="mt-2 text-muted">No questions found</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Question Modal -->
<div class="modal fade" [class.show]="showAddModal" [style.display]="showAddModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Question</h5>
        <button type="button" class="btn-close" (click)="closeAddModal()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row">
            <div class="col-md-12 mb-3">
              <label class="form-label">Episode <span class="text-danger">*</span></label>
              <select class="form-select" [(ngModel)]="newQuestion.episodeId" name="episodeId" required>
                <option value="">Select Episode</option>
                <option *ngFor="let episode of episodes" [value]="episode._id">{{ episode.title }}</option>
              </select>
            </div>
            <div class="col-md-12 mb-3">
              <label class="form-label">Question Text <span class="text-danger">*</span></label>
              <textarea class="form-control" [(ngModel)]="newQuestion.questionText" name="questionText" rows="3" required></textarea>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Question Type <span class="text-danger">*</span></label>
              <select class="form-select" [(ngModel)]="newQuestion.questionType" name="questionType" required>
                <option *ngFor="let type of questionTypes" [value]="type.value">{{ type.label }}</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Difficulty <span class="text-danger">*</span></label>
              <select class="form-select" [(ngModel)]="newQuestion.difficulty" name="difficulty" required>
                <option *ngFor="let diff of difficulties" [value]="diff">{{ diff }}</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Points</label>
              <input type="number" class="form-control" [(ngModel)]="newQuestion.points" name="points" min="1">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Time Limit (seconds)</label>
              <input type="number" class="form-control" [(ngModel)]="newQuestion.timeLimit" name="timeLimit" min="1">
            </div>
            <div class="col-md-12 mb-3" *ngIf="newQuestion.questionType === 'multiple-choice'">
              <label class="form-label">Options</label>
              <div *ngFor="let option of newQuestion.options; let i = index" class="input-group mb-2">
                <input type="text" class="form-control" [(ngModel)]="newQuestion.options![i]" [name]="'option' + i" placeholder="Option {{ i + 1 }}">
                <button class="btn btn-outline-danger" type="button" (click)="removeOption(i)" *ngIf="newQuestion.options!.length > 2">
                  <i class="feather icon-x"></i>
                </button>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" (click)="addOption()">
                <i class="feather icon-plus me-1"></i>Add Option
              </button>
            </div>
            <div class="col-md-12 mb-3">
              <label class="form-label">Correct Answer <span class="text-danger">*</span></label>
              <input type="text" class="form-control" [(ngModel)]="newQuestion.correctAnswer" name="correctAnswer" required>
            </div>
            <div class="col-md-12 mb-3">
              <label class="form-label">Explanation</label>
              <textarea class="form-control" [(ngModel)]="newQuestion.explanation" name="explanation" rows="2"></textarea>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Order</label>
              <input type="number" class="form-control" [(ngModel)]="newQuestion.order" name="order" min="1">
            </div>
            <div class="col-md-6 mb-3">
              <div class="form-check mt-4">
                <input class="form-check-input" type="checkbox" [(ngModel)]="newQuestion.isActive" name="isActive" id="isActive">
                <label class="form-check-label" for="isActive">
                  Active
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeAddModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="addQuestion()">Add Question</button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showAddModal" *ngIf="showAddModal"></div>

<!-- Edit Question Modal -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Question</h5>
        <button type="button" class="btn-close" (click)="closeEditModal()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row">
            <div class="col-md-12 mb-3">
              <label class="form-label">Episode <span class="text-danger">*</span></label>
              <select class="form-select" [(ngModel)]="editQuestion.episodeId" name="episodeId" required>
                <option value="">Select Episode</option>
                <option *ngFor="let episode of episodes" [value]="episode._id">{{ episode.title }}</option>
              </select>
            </div>
            <div class="col-md-12 mb-3">
              <label class="form-label">Question Text <span class="text-danger">*</span></label>
              <textarea class="form-control" [(ngModel)]="editQuestion.questionText" name="questionText" rows="3" required></textarea>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Question Type <span class="text-danger">*</span></label>
              <select class="form-select" [(ngModel)]="editQuestion.questionType" name="questionType" required>
                <option *ngFor="let type of questionTypes" [value]="type.value">{{ type.label }}</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Difficulty <span class="text-danger">*</span></label>
              <select class="form-select" [(ngModel)]="editQuestion.difficulty" name="difficulty" required>
                <option *ngFor="let diff of difficulties" [value]="diff">{{ diff }}</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Points</label>
              <input type="number" class="form-control" [(ngModel)]="editQuestion.points" name="points" min="1">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Time Limit (seconds)</label>
              <input type="number" class="form-control" [(ngModel)]="editQuestion.timeLimit" name="timeLimit" min="1">
            </div>
            <div class="col-md-12 mb-3" *ngIf="editQuestion.questionType === 'multiple-choice'">
              <label class="form-label">Options</label>
              <div *ngFor="let option of editQuestion.options; let i = index" class="input-group mb-2">
                <input type="text" class="form-control" [(ngModel)]="editQuestion.options![i]" [name]="'editOption' + i" placeholder="Option {{ i + 1 }}">
                <button class="btn btn-outline-danger" type="button" (click)="removeEditOption(i)" *ngIf="editQuestion.options!.length > 2">
                  <i class="feather icon-x"></i>
                </button>
              </div>
              <button type="button" class="btn btn-sm btn-outline-primary" (click)="addEditOption()">
                <i class="feather icon-plus me-1"></i>Add Option
              </button>
            </div>
            <div class="col-md-12 mb-3">
              <label class="form-label">Correct Answer <span class="text-danger">*</span></label>
              <input type="text" class="form-control" [(ngModel)]="editQuestion.correctAnswer" name="correctAnswer" required>
            </div>
            <div class="col-md-12 mb-3">
              <label class="form-label">Explanation</label>
              <textarea class="form-control" [(ngModel)]="editQuestion.explanation" name="explanation" rows="2"></textarea>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Order</label>
              <input type="number" class="form-control" [(ngModel)]="editQuestion.order" name="order" min="1">
            </div>
            <div class="col-md-6 mb-3">
              <div class="form-check mt-4">
                <input class="form-check-input" type="checkbox" [(ngModel)]="editQuestion.isActive" name="isActiveEdit" id="isActiveEdit">
                <label class="form-check-label" for="isActiveEdit">
                  Active
                </label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="updateQuestion()">Update Question</button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showEditModal" *ngIf="showEditModal"></div>

<!-- Delete Question Modal -->
<div class="modal fade" [class.show]="showDeleteModal" [style.display]="showDeleteModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Question</h5>
        <button type="button" class="btn-close" (click)="closeDeleteModal()"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this question?</p>
        <p class="text-muted"><strong>{{ deleteQuestionText }}</strong></p>
        <div class="alert alert-warning">
          <i class="feather icon-alert-triangle me-2"></i>
          This action cannot be undone.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()">Delete</button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showDeleteModal" *ngIf="showDeleteModal"></div>
